# MySql

## 安装

### 下载mysql

1. 官网下载 5.7.X
```
https://dev.mysql.com/downloads/mysql/5.7.html
centos 对应的是 Red Hat Enterprise Linux / Oracle Linux
7 对应 Red Hat Enterprise Linux 7 / Oracle Linux 7 (x86, 64-bit)
也可以下载 Linux - Generic 版本
```
2. 利用wget 下载
```
cd /data
# 创建一个目录 mysql目录
mkdir /data/mysql
# 进入 /data/mysql目录
cd ./mysql
# 下载文件
wget https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.32-linux-glibc2.12-x86_64.tar.gz
或
wget https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.32-el7-x86_64.tar.gz
```

### 解压到 /data/mysql

1. 解压
```
tar xzf mysql-5.7.32-linux-glibc2.12-x86_64.tar.gz
```

2. 文件夹改名为mysql-5.7.32
```
mv mysql-5.7.32-linux-glibc2.12-x86_64 mysql-5.7.32
```

### 配置

1. 进入mysql目录
```
cd /data/mysql/mysql-5.7.32
```
2. 创建my.cnf文件
```
vim my.cnf
```
// 输入以下内容
```
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html
# *** DO NOT EDIT THIS FILE. It's a template which will be copied to the
# *** default location during install, and will be replaced if you
# *** upgrade to a newer version of MySQL.

[client]
port = 3306
#socket = /tmp/mysql.sock

[mysqld]

# 这里一定要配用户 否则启动不了，报错Starting MySQL…The server quit without updating PID file
user = root

# pid文件
pid-file = /data/mysql/mysql-5.7.32/mysqld.pid

# 不区分大小写
lower_case_table_names = 1

# Mysql服务的唯一编号 每个mysql服务Id需唯一
server-id = 1

# 服务端口号 默认3306
port = 3306

# mysql安装根目录
basedir = /data/mysql/mysql-5.7.32

# mysql数据文件所在位置
datadir = /data/mysql/mysql-5.7.32/data

# 临时目录 比如load data infile会用到
tmpdir  = /tmp

# 设置socke文件所在目录
#socket  = /tmp/mysql.sock

character-set-server=utf8
 
collation-server=utf8_general_ci

# 时区 00:00
default-time_zone = '+00:00'

# 只能用IP地址检查客户端的登录，不用主机名
skip_name_resolve = 1

# SQL数据包发送的大小，如果有BLOB对象建议修改成1G
max_allowed_packet = 20M

# MySQL连接闲置超过一定时间后(单位：秒)将会被强行关闭
# MySQL默认的wait_timeout  值为8个小时, interactive_timeout参数需要同时配置才能生效
interactive_timeout = 1800
wait_timeout = 1800

# 内部内存临时表的最大值 ，设置成128M。
# 比如大数据量的group by ,order by时可能用到临时表，
# 超过了这个值将写入磁盘，系统IO压力增大
tmp_table_size = 134217728
max_heap_table_size = 134217728

# 关闭关于 TIMESTAMP with implicit DEFAULT value is deprecated. 的警告
explicit_defaults_for_timestamp = true

# 开启事件功能
event_scheduler= ON

#日志设置

# 数据库错误日志文件
log_error = /data/mysql/mysql-5.7.32/logs/error.log

# 慢查询sql日志设置
slow_query_log = 1
slow_query_log_file = /data/mysql/mysql-5.7.32/logs/slow.log

# 检查未使用到索引的sql
log_queries_not_using_indexes = 1

# 针对log_queries_not_using_indexes开启后，记录慢sql的频次、每分钟记录的条数
log_throttle_queries_not_using_indexes = 5

# 作为从库时生效,从库复制中如何有慢sql也将被记录
#log_slow_slave_statements = 1

# 慢查询执行的秒数，必须达到此值可被记录
#long_query_time = 8

# 检索的行数必须达到此值才可被记为慢查询
#min_examined_row_limit = 100

# mysql binlog日志文件保存的过期时间，过期后自动删除
#expire_logs_days = 5

# 密码过期处理
# skip-grant-tables

# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M

# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
# log_bin

# These are commonly set, remove the # and set as required.
# basedir = .....
# datadir = .....
# port = .....
# server_id = .....
# socket = .....

# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M 

sql_mode=NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
```

3. 进入 support-files 目录
```
cd ./support-files
```
4. 配置 mysql.server 文件
```
vim mysql.server
```
```
# 找到
basedir=
datadir=
# 修改为
basedir=/data/mysql/mysql-5.7.32
datadir=/data/mysql/mysql-5.7.32/data
```
按ESC, 输入:wq保存退出

5. 添加环境变量
```
# 打开文件
vim /etc/profile
```
输入以下内容，注意添加在export之前，且把MYSQL_HOME变量也加在export 后面
```
MYSQL_HOME=/data/mysql/mysql-5.7.32

PATH=$PATH:$MYSQL_HOME/bin
```
PATH有别的内容可以用冒号分隔，如以下格式

```
PATH=$PATH:$JAVA_HOME:$MYSQL_HOME/bin
```

让配置生效

```
source /etc/profile
或
. /etc/profile
```

6. 初始化数据库，得到初始随机密码

```
# 回到安装目录
cd /data/mysql/mysql-5.7.32
```
```
./bin/mysqld --user=root --basedir=/data/mysql/mysql-5.7.32 --datadir=/data/mysql/mysql-5.7.32/data --initialize
```
初始化时，如果出现以下错误
```
[root@vm mysql-5.7.32]# ./bin/mysqld --user=root --basedir=/data/mysql/mysql-5.7.32 --datadir=/data/mysql/mysql-5.7.32/data --initialize
./bin/mysqld: error while loading shared libraries: libaio.so.1: cannot open shared object file: No such file or directory
[root@iZk1a23odcrt4vsq3y1k5iZ mysql-5.7.32]# /data/mysql/mysql-5.7.32/bin/mysqld --user=root --basedir=/data/mysql/mysql-5.7.32 --datadir=/data/mysql/mysql-5.7.32/data --initialize
/data/mysql/mysql-5.7.32/bin/mysqld: error while loading shared libraries: libaio.so.1: cannot open shared object file: No such file or directory
```
执行以下命令安装 libaio就可以
```
yum install -y libaio
如果安装了 libaio还报错 再装下边这个
yum -y install numactl
```

执行成功
```
[root@iZk1a23odcrt4vsq3y1k5iZ mysql-5.7.32]# ./bin/mysqld --user=root --basedir=/data/mysql/mysql-5.7.32 --datadir=/data/mysql/mysql-5.7.32/data --initialize 
2019-12-25T07:32:46.578857Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).
2019-12-25T07:32:47.435848Z 0 [Warning] InnoDB: New log files created, LSN=45790
2019-12-25T07:32:47.547091Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.
2019-12-25T07:32:47.607376Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: bf8b66bc-26e8-11ea-bb5f-00163e016e15.
2019-12-25T07:32:47.608995Z 0 [Warning] Gtid table is not ready to be used. Table 'mysql.gtid_executed' cannot be opened.
2019-12-25T07:32:48.259871Z 0 [Warning] CA certificate ca.pem is self signed.
2019-12-25T07:32:48.366286Z 1 [Note] A temporary password is generated for root@localhost: M*(gwtohC1_r  // 这个就是初始密码
```

7. 启动服务

```
# 启动前 在/var/log 下创建 mariadb文件夹，并在文件夹中创建 mariadb.log 文件
# 否则启动会报错
cd /var/log
mkdir /var/log/mariadb

# 创建 logs 目录 并创建 slow.log文件
cd /data/mysql/mysql-5.7.32/
mkdir /data/mysql/mysql-5.7.32/logs
```
```
# 失败提示
[root@tg-apps2 mysql-5.7.32]# ./support-files/mysql.server start
Starting MySQL.Logging to '/var/log/mariadb/mariadb.log'.
The server quit without updating PID file (/data/mysql/mysq[FAILED]/mysqld.pid).
```

```
# 启动
./support-files/mysql.server start
```
```
# 成功提示
[root@tg-apps2 mysql-5.7.32]# ./support-files/mysql.server start
Starting MySQL. 

# 如果提示 /var/lib/mysql 不存在
[root@sql3 mysql-5.7.32]# ./support-files/mysql.server start
Starting MySQL.2020-12-31T06:35:20.257894Z mysqld_safe Directory '/var/lib/mysql' for UNIX socket file don't exists.
 ERROR! The server quit without updating PID file (/data/mysql/mysql-5.7.32/mysqld.pid).

# 创建一个就可以
mkdir /var/lib/mysql
```

8. 以初始密码登陆, 并修改密码
```
mysql -u root -p
```
```
# 如果服务没启动会出现以下提示
ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/tmp/mysql.sock' (2)

# 5.7.32版本出现以下提示时, 修改mysql.sock位置为默认就可以
ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' (2)

# 找一下文件在哪 一般在/var/lib/mysql/mysql.sock但改了my.cnf到这里还是不成功
find / -name mysql.sock

# 设置软链到默认地址
ln -s /var/lib/mysql/mysql.sock /tmp/mysql.sock

# 查看是否成功
ls /tmp/


# 如果没配置环境变量会出现以下提示
[root@tg-apps2 mysql-5.7.32]# mysql -u root -p
-bash: mysql: command not found
```
关于密码过期的处理

```
# 密码过期提示
ERROR 1862 (HY000): Your password has expired. To log in you must change it using a client that supports expired passwords.
```

```
# 用忽略授权表的方法进入mysql
vim /etc/my.cnf

# 在 [mysqld] 下增加一行 :wq! #保存退出
skip-grant-tables

# 重启mysql服务 用mysql -u root 进入

# 换库
use mysql;
# 查询一下过期字段 password_expired
MySQL [mysql]> select * from mysql.user where user='root' \G;
*************************** 1. row ***************************
                  Host: %
                  User: root
           Select_priv: Y
           Insert_priv: Y
           Update_priv: Y
           Delete_priv: Y
           Create_priv: Y
             Drop_priv: Y
           Reload_priv: Y
         Shutdown_priv: Y
          Process_priv: Y
             File_priv: Y
            Grant_priv: Y
       References_priv: Y
            Index_priv: Y
            Alter_priv: Y
          Show_db_priv: Y
            Super_priv: Y
 Create_tmp_table_priv: Y
      Lock_tables_priv: Y
          Execute_priv: Y
       Repl_slave_priv: Y
      Repl_client_priv: Y
      Create_view_priv: Y
        Show_view_priv: Y
   Create_routine_priv: Y
    Alter_routine_priv: Y
      Create_user_priv: Y
            Event_priv: Y
          Trigger_priv: Y
Create_tablespace_priv: Y
              ssl_type: 
            ssl_cipher: 
           x509_issuer: 
          x509_subject: 
         max_questions: 0
           max_updates: 0
       max_connections: 0
  max_user_connections: 0
                plugin: mysql_native_password
 authentication_string: *453AB2FE2A97668F1B146C711C8D8F8FF9E41076
      password_expired: Y
 password_last_changed: 2020-10-29 10:01:04
     password_lifetime: NULL
        account_locked: N
1 row in set (0.00 sec)

ERROR: No query specified

# 把password_expired 改成不过期
update user set password_expired='N' where user='root';

# 生效
flush privileges;
quit

# 把my.cnf 的 skip-grant-tables 这行注释掉
# 重启服务
```

输入初始密码(xshell中可以复制粘贴)后，通过以下命令修改密码

```
# new password 为新密码
ALTER USER 'root'@'localhost' IDENTIFIED BY 'new password';
```

以下不是必须
a. 刚改完码后不记得了，可以到mysql目录下，找到data，重命名为data1或其他名字，然后重新执行初始化操作。记得改名之前需要停止mysql服务

b. 运行期改密码
```
# 输入
mysql> use mysql;
Database changed

# 修改root密码
mysql> update mysql.user set authentication_string=password('abc') where user='root';

# 成功提示
Query OK, 1 row affected, 1 warning (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 1

# 密码生效
mysql> flush privileges;
Query OK, 0 rows affected (0.00 sec)

```

9. 开启远程访问
在mysql的命令行中输入以下指令
```
# 执行
use mysql; // 回车
```
```
# 提示
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
```

```
# 执行
select host,user from user; // 回车
```
```
# 提示
+-----------+---------------+
| host      | user          |
+-----------+---------------+
| localhost | mysql.session |
| localhost | mysql.sys     |
| localhost | root          |
+-----------+---------------+
3 rows in set (0.00 sec)
```

```
# 执行
update user set host='%' where user='root';
```
```
# 提示
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0
```

```
# 最后执行
flush privileges;
```



## 启动与停止

./support-files/ 目录在mysql的安装目录下 本文在 /data/mysql/mysql-5.7.32/ 下

### 启动

1. 利用support-files中的mysql.server

```
./support-files/mysql.server start
```



### 停止

注意不要强行kill pid进程，否则很有可能造成表损坏

1. 利用support-files中的mysql.server
```
./support-files/mysql.server stop
```

### 重启

1. 利用support-files中的mysql.server
```
./support-files/mysql.server restart
```

## 常用命令



### 查看进程列表

```sql
# 只列出当前100条
SHOW processlist;
```

```sql
# 列出所有
SHOW FULL processlist;
```

```
# kill线程
kill processlist_id
```

```
mysql> show processlist;
+----+------+---------------------+--------------------+---------+------+
| Id | User | Host                | db                 | Command | Time | 
+----+------+---------------------+--------------------+---------+------+
| 36 | root | 172.16.100.19:7954  | tpcc_test          | Sleep   |    8 |
| 37 | root | 172.16.100.19:7969  | tpcc_test          | Sleep   |    8 |
| 42 | root | localhost           | NULL               | Query   |    0 | 
| 43 | root | 10.0.102.204:49224  | employees          | Sleep   | 2564 |
| 44 | root | 172.16.100.19:14529 | NULL               | Sleep   | 2322 |
| 45 | root | 172.16.100.19:14770 | information_schema | Sleep   | 2315 |
+----+------+---------------------+--------------------+---------+------+-------------+
6 rows in set (0.00 sec)

mysql> kill 43;              #kill掉43线程
```



### 清空表

```sql
// 速度快 不产生日志 重置自增长id 不可恢复
TRUNCATE TABLE 表名;
```
```sql
// 速度慢 可恢复 不重置自增长id
DELETE FROM 表名;
```



### 占空间统计

```
# 必须进入这个库先
use information_schema;
```

```
# 查看指定库的大小 如 pass 库
SELECT
	concat(
		round(
			sum(data_length / 1024 / 1024),
			2
		),
		'MB'
	) AS DATA
FROM
	TABLES
WHERE
	table_schema = 'pass';
```

```
# 查看指定表大小 如 pass 库下的 t_syslog 表
SELECT
	concat(
		round(
			sum(data_length / 1024 / 1024),
			2
		),
		'MB'
	) AS DATA
FROM
	TABLES
WHERE
	table_schema = 'pass'
AND table_name = 't_syslog';
```

```
# 查看所有数据库容量大小
SELECT
	table_schema AS '数据库',
	sum(table_rows) AS '记录数',
	sum(
		TRUNCATE (data_length / 1024 / 1024, 2)
	) AS '数据容量(MB)',
	sum(
		TRUNCATE (index_length / 1024 / 1024, 2)
	) AS '索引容量(MB)'
FROM
	information_schema. TABLES
GROUP BY
	table_schema
ORDER BY
	sum(data_length) DESC,
	sum(index_length) DESC;
```

```
# 查看所有数据库各表容量大小
SELECT
	table_schema AS '数据库',
	table_name AS '表名',
	table_rows AS '记录数',
	TRUNCATE (data_length / 1024 / 1024, 2) AS '数据容量(MB)',
	TRUNCATE (index_length / 1024 / 1024, 2) AS '索引容量(MB)'
FROM
	information_schema. TABLES
ORDER BY
	data_length DESC,
	index_length DESC;
```

```
# 查看指定数据库容量大小 如 mysql库
SELECT
	table_schema AS '数据库',
	sum(table_rows) AS '记录数',
	sum(
		TRUNCATE (data_length / 1024 / 1024, 2)
	) AS '数据容量(MB)',
	sum(
		TRUNCATE (index_length / 1024 / 1024, 2)
	) AS '索引容量(MB)'
FROM
	information_schema. TABLES
WHERE
	table_schema = 'mysql';
```

```
# 查看指定数据库各表容量大小 如mysql下的所有表
SELECT
	table_schema AS '数据库',
	table_name AS '表名',
	table_rows AS '记录数',
	TRUNCATE (data_length / 1024 / 1024, 2) AS '数据容量(MB)',
	TRUNCATE (index_length / 1024 / 1024, 2) AS '索引容量(MB)'
FROM
	information_schema. TABLES
WHERE
	table_schema = 'mysql'
ORDER BY
	data_length DESC,
	index_length DESC;
```





### 格式化数字

```
# 格式化数字补0  参数 数值, 共多少位, 用0填充
SELECT LPAD(12, 6 , 0)
# 输出 000012
```

### 连接字符串

```
# 输出 CAR123
SELECT CONCAT('CAR', '123')
```



### 验证语句是否使用了索引

```
# 使用 explain 命令
explain SELECT * from terminal_position where data_time > '2020-07-30'
```





## 分区表

- 一个表最多支持1024个分区
- 如果分区字段中有主键或唯一索引的列，那么所有主键列和唯一索引列都必须包含进来
- 分区表无法使用外键约束
- 所有分区必须使用相同的存储引擎

### 创建分区表

注：用于分区的字段必须为主键, 用时间做主键时需要加上id做联合主键，因为时间容易重复。分区参数中 “LESS THAN” 是小于的意思

1. 按年份分区

```sql
// 按年份分区
CREATE TABLE `表名` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `data_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP
    PRIMARY KEY (`id`, `data_time`)
) ENGINE = INNODB PARTITION BY RANGE (YEAR(data_time))(
    PARTITION `p_2018` VALUES LESS THAN (2019),
    PARTITION `p_2019` VALUES LESS THAN (2020)
);
```
2. 按月份分区
```sql
# 按月份分区
CREATE TABLE `表名` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `data_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP
    PRIMARY KEY (`id`, `data_time`)
) ENGINE = INNODB PARTITION BY RANGE (TO_DAYS(data_time))(
    PARTITION `p_201812` VALUES	LESS THAN (TO_DAYS('2019-01-01')),
    PARTITION `p_201901` VALUES LESS THAN (TO_DAYS('2019-02-01')),
    PARTITION `p_201902` VALUES LESS THAN (TO_DAYS('2019-03-01'))
);
```

```
# 例如
CREATE TABLE `terminal_position` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `imei`  varchar(32) NOT NULL ,
    `city_id`  varchar(16) NOT NULL DEFAULT '' ,
    `route_code`  varchar(16) NOT NULL DEFAULT '' ,
    `station_no`  int(11) NULL DEFAULT 0 ,
    `direction`  int(11) NULL DEFAULT 0 ,
    `latitude`  decimal(11,6) NULL DEFAULT 0.000000 ,
    `longitude`  decimal(11,6) NULL DEFAULT 0.000000 ,
    `state`  int(11) NULL DEFAULT 0 ,
    `warning`  int(11) NULL DEFAULT 0 ,
    `speed`  int(11) NULL DEFAULT 0 ,
    `azimuth`  int(11) NULL DEFAULT 0 ,
    `height`  int(11) NULL DEFAULT 0 ,
    `mileage`  decimal(11,3) NULL DEFAULT 0.000 ,
    `data_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `create_time`  datetime NULL DEFAULT CURRENT_TIMESTAMP,
    `update_time`  datetime NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP ,
    PRIMARY KEY (`id`, `data_time`)
) ENGINE = INNODB PARTITION BY RANGE (TO_DAYS(data_time))(
    PARTITION `p_202006` VALUES LESS THAN (TO_DAYS('2020-07-01')),
    PARTITION `p_202007` VALUES LESS THAN (TO_DAYS('2020-08-01')),
    PARTITION `p_202008` VALUES LESS THAN (TO_DAYS('2020-09-01'))
);
```



### 普通表转为分区表

```
略
```



###  增加分区

以按月分区为例

```sql
ALTER TABLE `表名`
ADD PARTITION (
    PARTITION `p_201903` VALUES LESS THAN (TO_DAYS('2019-04-01')),
    PARTITION `p_201904` VALUES LESS THAN (TO_DAYS('2019-05-01'))
);
```



###  删除分区

注: 删除多个分区可以在多个分区名间用逗号(,) 分开

```sql
ALTER TABLE `表名` DROP PARTITION `分区名1`,`分区名2`;
```



### 自动创建新分区

1. 创建存储过程, 每次执行检测下个月的分区是否创建, 如果不存在则创建

```sql
DELIMITER $$
# 该表所在数据库名称 如gateway
USE `gateway`$$
DROP PROCEDURE IF EXISTS `p_create_partition_by_month`$$
CREATE PROCEDURE `p_create_partition_by_month`(IN_SCHEMANAME VARCHAR(64), IN_TABLENAME VARCHAR(64))
BEGIN
    # 需要创建的分区的个数
    DECLARE ROWS_CNT INT UNSIGNED;
    # 目前日期
    DECLARE TARGET_DATE TIMESTAMP;
    # 分区的名称，格式为p_201806
    DECLARE PARTITIONNAME VARCHAR(8);
    # 当前分区名称的分区值上限，即为 PARTITIONNAME + 1
    DECLARE PARTITION_ADD_MONTH VARCHAR(10);

    # 当前时间 + 一个月 表下个月
    SET TARGET_DATE = NOW() + INTERVAL 1 MONTH;
    # 需要新建的分区名 格式为p_201806
    SET PARTITIONNAME = DATE_FORMAT( TARGET_DATE, 'p_%Y%m' );
    
    # 新分区参数需要再加一个月 如 p_201806 对应的是 2018-07-01 表示小于2018-07-01的数据存放p_201806
    SET TARGET_DATE = TARGET_DATE + INTERVAL 1 MONTH;
    # LESS THAN 后的参数, 格式为2018-07-01
    SET PARTITION_ADD_MONTH = DATE_FORMAT( TARGET_DATE, '%Y-%m-01' );

    # 检查要建的分区是否存在
    SELECT COUNT(*) INTO ROWS_CNT FROM 
        information_schema.partitions
    WHERE table_schema = IN_SCHEMANAME AND table_name = IN_TABLENAME AND partition_name = PARTITIONNAME;

    IF ROWS_CNT = 0 THEN
        # 要建的分区不存在就创建
        SET @SQL = CONCAT( 'ALTER TABLE `', IN_SCHEMANAME, '`.`', IN_TABLENAME, '`',
            ' ADD PARTITION (PARTITION `', PARTITIONNAME, "` VALUES LESS THAN (TO_DAYS('",
            PARTITION_ADD_MONTH ,"')));" );
        SELECT @SQL;
        PREPARE STMT FROM @SQL;
        EXECUTE STMT;
        DEALLOCATE PREPARE STMT;
    ELSE
        SELECT CONCAT("partition `", PARTITIONNAME, "` for table `",IN_SCHEMANAME, ".", IN_TABLENAME, "` already exists") AS result;
    END IF;
END$$
DELIMITER ;
```

2. 数据库定时任务(每天)
```sql
DELIMITER $$
# 该表所在的数据库名称
USE `gateway`$$
CREATE EVENT IF NOT EXISTS `e_daily_generate_partition`
# 执行周期，还有时、天、月等等
ON SCHEDULE EVERY 1 day
STARTS '2019-12-01 00:00:00'
ON COMPLETION PRESERVE
ENABLE
COMMENT 'Creating partitions'
DO BEGIN
    # 调用刚才创建的存储过程，第一个参数是数据库名称，第二个参数是表名称
    CALL p_create_partition_by_month('gateway','terminal_position');
END$$
DELIMITER ;
```

3. 定时任务 如果没有执行，请检查MySql是否开启了event(默认是关闭的) 
```
[mysqld]
event_scheduler=ON
```



### 查看分区表数据信息

```sql
SELECT
    TABLE_SCHEMA,
    TABLE_NAME,
    PARTITION_NAME,
    TABLE_ROWS
FROM
    information_schema.PARTITIONS
WHERE
    TABLE_NAME = '表名'
```



## 参数配置

注: 以下通用 set global xxx 配置的参数, 在mysql重启后会失效

### 调整执行sql语句的长度

1. 查询默认值 默认为 1048576 也就是 1M

```sql
show VARIABLES like '%max_allowed_packet%';
```
2. 修改默认值大小 如 10M, 

```
// 注意修改后需要断开session, 再重新建立连接session查询才能看到修改后的效果
// 对当前会话无效
set global max_allowed_packet = 1*1024*1024*10
```



###  开启事件功能

1. 检测事件是否开启, event_scheduler: ON/OFF

```sql
show variables like 'event_scheduler';
```
2. 开启事件

```sql
set global event_scheduler = on;
```

3. 永久开启, my.ini/my.conf中修改, 需重启mysql
```
[mysqld]
event_scheduler=ON
```



### 设置时区

1. 查看时区，默认跟系统同一时区

```
SHOW VARIABLES LIKE "%time_zone%";
```

2. 修改时区，马上生效，但重启后会失效

```
// 设为utc时区
SET GLOBAL time_zone = '+00:00';
// 刷新一下
FLUSH PRIVILEGES;
```


3. 永久生效

```
// 打开my.conf, 在 [mysqld]节点下增加以下内容，重启生效
# 时区 00:00
default-time_zone = '+00:00'
```



## 配置复制



### 创建复制账号

```
# 建议在每一台服务器上都创建账号 但这不是必须的，实际只有主库需要这个账号
# 指定局域网，让它只能运行在局域网中
# p4ssword 表密码
# repl 表账号
mysql> GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.*
    -> TO repl@'10.1.254.%' IDENTIFIED By 'p4ssword';
```



### 配置主库和备库

1. 配置主库

```
# my.cnf中增加

# 指定唯一的服务器id, 通常做法是ip的后8位
server_id = 164186

# 打开二进制日志 日志名叫mysql-bin 但也可以叫其他名字
# 建议指定log_bin文件名以保证二进制日志名在所有服务器上是一致的
log_bin = /data/mysql/mysql-bin

# 主库上重要的选项 增加安全性(备库不需要)
sync_binlog = 1

# InnoDB引擎 建议增加以下配置 以下是5.0+版本默认配置
#innodb_flush_logs_at_trx_commit
#innodb_support_xa = 1
#innodb_safe_binlog
```

```
# 配置好后重启 输入以下命令查看状态
SHOW MASTER STATUS;
```

```
# 显示结果如下
MySQL [(none)]> SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000001 |      458 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
```


2. 配置备库

```
# 备库使用跟主库相同的配置并增加一些选项

# 指定唯一的服务器id, 通常做法是ip的后8位
server_id = 164185

# 打开二进制日志
log_bin = /data/mysql/mysql-bin

# 指定中继日志的位置与命名
relay_log = /data/mysql/mysql-relay-bin

# 最好开启 不然可能会出现一些奇怪的问题
log_slave_updates = 1

# 阻止备库在崩溃后自动启动复制 也意味着重启备库后需要手动启动复制
skip_slave_start

# 不介意的fync()导致的开销, 最好设置以下, 保护备库
sync_master_info = 1
sync_relay_log = 1
sync_relay_log_info = 1

# 只读 如果可能建议开启 但不是很实用 有时备库需要建表等操作 聂工要在从库写数据 这里禁用
#read_only = 1
```



### 启动复制

1. 告诉备库连接到主库并重发二进制日志

```
# 执行 CHANGE MASTER TO 启动复制
# 使用命令代替my.cnf中的配置, 并允许以后指向别的主库时无须重启备库
# MASTER_LOG_POS = 0 表示从日志开头读起
mysql> CHANGE MASTER TO MASTER_HOST = '10.1.254.43',
    -> MASTER_PORT = 9600,
    -> MASTER_USER = 'repl',
    -> MASTER_PASSWORD = 'p4ssword',
    -> MASTER_LOG_FILE = 'mysql-bin.000001',
    -> MASTER_LOG_POS = 0;
```

2. 查看备库状态
```
SHOW SLAVE STATUS\G;
```

```
# 显示结果
MySQL [(none)]> SHOW SLAVE STATUS\G;
*************************** 1. row ***************************
               Slave_IO_State: 
                  Master_Host: 10.1.254.43
                  Master_User: repl
                  Master_Port: 9600
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: 4
               Relay_Log_File: mysql-relay-bin.000001
                Relay_Log_Pos: 4
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: No
            Slave_SQL_Running: No
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 4
              Relay_Log_Space: 154
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: NULL
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 0
                  Master_UUID: 
             Master_Info_File: /data/mysql/mysql-5.7.32/data/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: 
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: No query specified
```

3. 启动复制
```
mysql> START SLAVE;
```

```
# 显示结果
MySQL [(none)]> SHOW SLAVE STATUS\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 10.1.254.43
                  Master_User: repl
                  Master_Port: 9600
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: 458
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 671
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 458
              Relay_Log_Space: 878
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 164186
                  Master_UUID: ed21888f-4b2d-11eb-a196-08f1ea748c28
             Master_Info_File: /data/mysql/mysql-5.7.32/data/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: 
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

ERROR: No query specified
```

4. 主库上查询复制线程
```
SHOW PROCESSLIST\G;
```

```
# 这里可以看到复制线程 id = 5 user = repl
MySQL [(none)]> SHOW PROCESSLIST\G;
*************************** 1. row ***************************
     Id: 1
   User: event_scheduler
   Host: localhost
     db: NULL
Command: Daemon
   Time: 1835
  State: Waiting on empty queue
   Info: NULL
*************************** 2. row ***************************
     Id: 5
   User: repl
   Host: 10.1.254.44:46550
     db: NULL
Command: Binlog Dump
   Time: 366
  State: Master has sent all binlog to slave; waiting for more updates
   Info: NULL
*************************** 3. row ***************************
     Id: 6
   User: root
   Host: localhost
     db: NULL
Command: Query
   Time: 0
  State: starting
   Info: SHOW PROCESSLIST
3 rows in set (0.00 sec)

ERROR: No query specified
```



## Windows Zip版本安装

### 安装与配置

1.下载

```
# 直接下载
https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.32-winx64.zip
```

2. 解压

```
# 如解压到E盘下的指定目录
E:\data\mysql-5.7.32-winx64
```

3. 配置环境变量

```
# 将bin添加到系统变量 path最后面, 注意与其他变量使用;分开
;E:\data\mysql-5.7.32-winx64\bin
```

4. 创建配置文件 my.ini

```
# 在E:\data\mysql-5.7.32-winx64目录下创建 my.ini
```
```
# 注意 my.ini 必须存为 ANSI编码格式, 其他格式可能无法启动服务
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html

[client]
port = 3306

[mysqld]

# 不区分大小写
lower_case_table_names = 1

# Mysql服务的唯一编号 每个mysql服务Id需唯一
# server-id = 1

# 服务端口号 默认3306
port = 3306

# mysql安装根目录 注意要两个\ 不然有的电脑会出错
basedir = E:\\data\\mysql-5.7.32-winx64

# mysql数据文件所在位置
datadir = E:\\data\\mysql-5.7.32-winx64\\data

# 设置mysql客户端默认字符集
character-set-server=utf8
 
collation-server=utf8_general_ci

# 时区 00:00 如果需要做国际化时可以设置 否则使用当前服务器时区
default-time_zone = '+00:00'

# 只能用IP地址检查客户端的登录，不用主机名
# 注意在初始安装里要注释掉这里
# skip_name_resolve = 1

# SQL数据包发送的大小，如果有BLOB对象建议修改成1G
max_allowed_packet = 20M

# MySQL连接闲置超过一定时间后(单位：秒)将会被强行关闭
# MySQL默认的wait_timeout  值为8个小时, interactive_timeout参数需要同时配置才能生效
interactive_timeout = 1800
wait_timeout = 1800

# 内部内存临时表的最大值 ，设置成128M。
# 比如大数据量的group by ,order by时可能用到临时表，
# 超过了这个值将写入磁盘，系统IO压力增大
tmp_table_size = 134217728
max_heap_table_size = 134217728

# 关闭关于 TIMESTAMP with implicit DEFAULT value is deprecated. 的警告
explicit_defaults_for_timestamp = true

# 开启事件功能
event_scheduler= ON

#日志设置

# 数据库错误日志文件
log_error = E:\data\mysql-5.7.32-winx64\logs\error.log

# 慢查询sql日志设置
slow_query_log = 1
slow_query_log_file = E:\data\mysql-5.7.32-winx64\logs\slow.log

# 检查未使用到索引的sql
log_queries_not_using_indexes = 1

# 针对log_queries_not_using_indexes开启后，记录慢sql的频次、每分钟记录的条数
log_throttle_queries_not_using_indexes = 5

# 作为从库时生效,从库复制中如何有慢sql也将被记录
#log_slow_slave_statements = 1

# 慢查询执行的秒数，必须达到此值可被记录
#long_query_time = 8

# 检索的行数必须达到此值才可被记为慢查询
#min_examined_row_limit = 100

# mysql binlog日志文件保存的过期时间，过期后自动删除
#expire_logs_days = 5

# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M 

sql_mode=NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
```

5. 安装服务(服务名一般默认为MySQL, 如果同一电脑安装多个mysql必须修改成不同服务名)

```
# 进入目录, 如 E:\data\mysql-5.7.32-winx64\bin
# 按住shift右键点空白的地方进行命令行模式
# 如 mysqld -install MySQL-7000
# 使用 sc delete 服务名，删除当前服务
mysqld -install
```
```
# 提示服务安装成功
# 如果报错Install/Remove of the Service Denied! 说明需要以管理员的身份进行安装
# 如果提示找不到MSVCP120.dll,需要先安装vcredist运行库
# 下载 vcredist 地址：https://www.microsoft.com/zh-CN/download/details.aspx?id=40784
E:\data\mysql-5.7.32-winx64\bin>mysqld -install
Service successfully installed.
```

6. 启动服务

```
# 需要先启动 否则无法完成初始化(在windows2019上没有初始化无法启动)
E:\data\mysql-5.7.32-winx64\bin>net start mysql
MySQL 服务正在启动 .
MySQL 服务已经启动成功。
```

7. 初始化MySQL

```
# MySQL5.7是不带data目录的，所以需要初始化MySQL，生产data目录
# 使用 mysqld --initialize 生成的密码在data目录下的：[pc名称].err文件中
# 使用 mysqld --initialize-insecure 这个命令初始化root用户密码为空
mysqld --initialize
```
```
# 完成时没有提示
E:\data\mysql-5.7.32-winx64\bin>mysqld --initialize
```
```
# 如果data目录存在 会有以下提示
E:\data\mysql-5.7.32-winx64\bin>mysqld --initialize
2020-07-11T07:45:19.520057Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).
2020-07-11T07:45:19.526057Z 0 [ERROR] --initialize specified but the data directory has files in it. Aborting.
2020-07-11T07:45:19.528057Z 0 [ERROR] Aborting
```

8. 启动服务

```
# 启动服务
net start mysql
```
```
E:\data\mysql-5.7.32-winx64\bin>net start mysql
MySQL 服务正在启动 .
MySQL 服务已经启动成功。
```

### 设置修改MySql密码

```
# 随机密码在 E:\data\mysql-5.7.32-winx64\data\[计算机名].err中
# 如果指定了错误日志文件, 将会记录在错误文件中
mysql -u root -p
```

```
# 连接出错 Host '::1' is not allowed to connect to this MySQL server
原因是 my.ini 里启用了 skip_name_resolve
1. 停止服务
2. 注释掉 # skip_name_resolve = 1
3. 启动服务
```

```
# 成功
E:\data\mysql-5.7.32-winx64\bin>mysql -u root -p
Enter password: ************ // 输入密码
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.32

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
```

```
# 在mysql>后输入以下命令修改密码
ALTER USER 'root'@'localhost' IDENTIFIED BY '新密码';
或
set password for root@localhost = password('新密码');
```
```
# 成功提示
mysql> ALTER USER 'root'@'localhost' IDENTIFIED BY '123456';
Query OK, 0 rows affected (0.00 sec)
```



### 开启远程访问

```
# 执行
use mysql; // 回车
```

```
# 提示
Database changed
```

```
# 执行
select host,user from user; // 回车
```

```
# 提示
+-----------+---------------+
| host      | user          |
+-----------+---------------+
| localhost | mysql.session |
| localhost | mysql.sys     |
| localhost | root          |
+-----------+---------------+
3 rows in set (0.00 sec)
```

```
# 执行
update user set host='%' where user='root';
```

```
# 提示
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0
```

```
# 最后执行
flush privileges;
```



### 启动与停止服务

```
# 启动服务
net start mysql
```

```
E:\data\mysql-5.7.32-winx64\bin>net start mysql
MySQL 服务正在启动 .
MySQL 服务已经启动成功。
```

```
# 停止服务 
net stop mysql
```

```
E:\data\mysql-5.7.32-winx64\bin>net stop mysql
MySQL 服务正在停止.
MySQL 服务已成功停止。
```

### 卸载

1. 停止服务

```
net stop mysql
```

2. 删除服务

```
mysqld --remove
```

3. 删除注册表

```
# 目录删除
HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Eventlog\Application\MySQL
```